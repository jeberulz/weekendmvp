<!-- 
  GOOGLE ANALYTICS & META PIXEL SNIPPET
  Copy this snippet and paste it right after the <link rel="canonical"> tag in any new page.
  
  Or use the auto-injection script: node scripts/inject-analytics.js <file.html>
-->

<!-- Google Analytics - Loaded conditionally after consent -->
<script>
  // Initialize dataLayer but don't load gtag.js until consent
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  
  // Check for existing consent
  (function() {
    try {
      const stored = localStorage.getItem('analytics_consent');
      if (stored) {
        const parsed = JSON.parse(stored);
        const CONSENT_EXPIRY_DAYS = 365;
        if (parsed.timestamp && Date.now() - parsed.timestamp < CONSENT_EXPIRY_DAYS * 24 * 60 * 60 * 1000) {
          window.analyticsConsent = parsed.value === true;
          if (window.analyticsConsent) {
            // Load GA immediately if consent exists
            const script = document.createElement('script');
            script.async = true;
            script.src = 'https://www.googletagmanager.com/gtag/js?id=G-Z1NYERTKRS';
            document.head.appendChild(script);
            script.onload = function() {
              window.gtag = function() { dataLayer.push(arguments); };
              gtag('js', new Date());
              gtag('config', 'G-Z1NYERTKRS');
            };
            // Initialize Meta Pixel immediately if consent exists
            if (typeof window.fbq === 'function') {
              window.fbq('init', '1602726847528813');
              window.fbq('track', 'PageView');
            }
            return;
          }
        }
      }
    } catch(e) {
      console.error('Error checking consent:', e);
    }
    window.analyticsConsent = false;
  })();
  
  // Wrapper to prevent gtag calls before consent
  if (!window.analyticsConsent) {
    window.gtag = function() {
      if (window.analyticsConsent === true) {
        dataLayer.push(arguments);
      }
    };
  } else {
    window.gtag = function() { dataLayer.push(arguments); };
  }
</script>

<!-- Meta Pixel - Loaded conditionally after consent -->
<script>
  // Initialize fbq queue but don't load until consent
  !function(f,b,e,v,n,t,s)
  {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
  n.callMethod.apply(n,arguments):n.queue.push(arguments)};
  if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
  n.queue=[];t=b.createElement(e);t.async=!0;
  t.src=v;s=b.getElementsByTagName(e)[0];
  s.parentNode.insertBefore(t,s)}(window, document,'script',
  'https://connect.facebook.net/en_US/fbevents.js');
  
  // Only initialize if consent exists
  if (window.analyticsConsent === true) {
    fbq('init', '1602726847528813');
    fbq('track', 'PageView');
  } else {
    // Queue the init call for when consent is given
    window.fbqQueue = window.fbqQueue || [];
    window.fbqQueue.push(['init', '1602726847528813']);
    window.fbqQueue.push(['track', 'PageView']);
  }
</script>
